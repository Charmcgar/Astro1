<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astro Chat</title>
</head>
<body>
  <div id="chatLog"></div>
  <input type="text" id="userInput" placeholder="Type your message here">
  <label>
    <input type="checkbox" id="smartModeToggle"> Smart Mode
  </label>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const chatLog = document.getElementById('chatLog');
      const input = document.getElementById('userInput');
      const smartToggle = document.getElementById('smartModeToggle');
      const apiKey = atob("c2ktc3RyaW5nLWluLXlvdXIta2V5"); // Example only; replace with your actual key.

      const systemPrompt = {
        role: "system",
        content: "You are Astro, a helpful AI assistant running on a secure private system."
      };

      let chatHistory = [];

      async function sendMessage() {
        const userText = input.value.trim();
        if (!userText) return;

        appendMessage("You", userText);
        input.value = "";
        appendMessage("Astro", "<i>Thinking...</i>");
        chatHistory.push({ role: "user", content: userText });

        const recent = chatHistory.slice(-8);
        const model = smartToggle.checked ? "gpt-4" : "gpt-3.5-turbo";

        try {
          const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model,
              messages: [systemPrompt, ...recent],
              max_tokens: 100
            })
          });

          const data = await res.json();
          removeLastAstroThinking();

          if (data.choices && data.choices.length) {
            const reply = data.choices[0].message.content;
            appendMessage("Astro", reply);
            chatHistory.push({ role: "assistant", content: reply });
          } else {
            appendMessage("Astro", "Could not get a response. Please try again.");
          }
        } catch (err) {
          removeLastAstroThinking();
          appendMessage("Astro", "An error occurred. Check the console for details.");
          console.error(err);
        }
      }

      function appendMessage(sender, message) {
        const msg = document.createElement("div");
        msg.classList.add("message");
        msg.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatLog.appendChild(msg);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function removeLastAstroThinking() {
        const last = chatLog.lastChild;
        if (last?.innerHTML.includes("<i>Thinking...</i>")) {
          chatLog.removeChild(last);
        }
      }

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    });
  </script>
</body>
</html>
